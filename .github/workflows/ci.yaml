name: CI Pipeline

on:
  push:
    branches:
      - master
      - develop
  pull_request:
    branches:
      - master
      - develop

jobs:
  lint-test:
    name: Lint, Format, and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Makefile targets
        run: |
          make format
          make lint
          make test

  docker:
    name: Build and Test Docker Image
    runs-on: ubuntu-latest
    needs: lint-test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image using Makefile
        run: make docker-build

      - name: Run Docker container
        run: |
          docker run  -d --name user_service_test -p 8000:8000 user_service
          sleep 5 

      - name: Test container endpoint
        run: |
            curl --fail http://localhost:8000/ping || (docker logs user_service_test && exit 1)

      - name: Stop and remove container
        if: always()
        run: |
          docker stop user_service_test
          docker rm user_service_test
